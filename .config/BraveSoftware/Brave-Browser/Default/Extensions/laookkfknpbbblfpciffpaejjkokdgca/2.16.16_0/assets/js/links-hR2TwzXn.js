import{E as t,u as e,aj as i,a1 as n,M as s,d as a,V as r}from"./icon-alert--q0yLTMi.js";import{v as d,E as o,P as l}from"./index-DQvfDEB6.js";import{u as c}from"./preload-helper-DmNsytk6.js";import{M as h}from"./compareObjects-BF7sSNEf.js";function u(t){return t.type===d.LinkGroup&&!t.isRoot}function m(t){return t.type===d.Legacy}function p(t){return t.type===d.Link}function k(t){return t.type===d.LinkGroup&&"isRoot"in t&&t.isRoot&&!("isTeamRoot"in t&&t.isTeamRoot)}function I(t){return t.type===d.LinkGroup&&"isTeamRoot"in t&&t.isTeamRoot}class g{constructor({id:t=c(),url:e=""}={}){this.id=t,this.url=e}}class f{constructor({id:t=e.uuidv4(),links:i=[],title:n="",pinned:s=!1,readOnly:a=!1}={}){this.id=t,this.links=i.map((t=>new g(t))),this.title=n,this.pinned=!!s,this.readOnly=a}get hasManyLinks(){return this.links.length>1}}function w({title:i,links:n}){if(0===i.length)throw new t({message:o.TITLE_EMPTY,input:"title"});if(0===n.length)throw new t({message:o.URL_EMPTY,input:"links.0"});n.forEach(((i,s)=>{(i.url||1===n.length)&&function({url:i},n){const s="links"+(void 0===n?"":`.${n}`);if(!i)throw new t({message:o.URL_EMPTY,input:s});if(!e.isValidUrl(i))throw new t({message:o.URL_INVALID,input:s})}(i,s)}))}class y{constructor(t){this.dataService=t}get(t){this.dataService.get({...t,success:e=>{(async()=>{var n;1===e.filter(k).length?t.success(e):0!==(null==(n=await i.get("links"))?void 0:n.cache)&&(await i.patch("links",{cache:0}),this.dataService.get(t))})()}})}create(t){return this.dataService.create(t.id,t)}update(t,e){return this.dataService.update(t,e)}delete(t){return this.dataService.delete(t)}}function v(t){return[{id:t.id,title:t.title,pinned:t.pinned,type:d.LinkGroup,readOnly:!1,linksOrderIds:t.links.map((t=>t.id))},...t.links.map((e=>({id:e.id,type:d.Link,url:e.url,parentLinkId:t.id})))]}function L(t){const e=Object.assign(new f,t);return e.links=e.links.filter((t=>t.url.length)).map((t=>Object.assign(new g,t,{url:t.url.includes("://")?t.url:"https://"+t.url}))),e}class O{constructor({id:t,url:e,title:i,pinned:n=!1,readOnly:s=!1}={}){if(!t||void 0===i||!e)throw new Error("Legacy link created with incomplete data");this.id=t,this.links=[new g({url:e})],this.title=i,this.pinned=!!n,this.readOnly=s}get hasManyLinks(){return this.links.length>1}}const E=(t=(()=>({linksService:new y(new n("links",{mode:s.Timestamp}))}))().linksService)=>a("links",{plugins:[l.MockData],state:()=>({data:{},loading:!1,loaded:!1,activeItemId:"",activeItem:null}),getters:{service:()=>t,getItems(){return({pinned:t=!1,team:e=!1}={})=>{var i;const n=e?this.getTeamRoot:this.getRoot;if(!n)return[];const s=[];return null==(i=n.linksOrderIds)||i.forEach((e=>{const i=this.getItemById(e);if(i&&(u(i)||m(i))&&(e=>"pinned"in e?e.pinned===t:!t)(i)){let t;u(i)?t=this.buildLinkGroup(i):m(i)&&(t=new O(i)),t&&t.links.length&&s.push(t)}})),s}},getUnPinnedItems(){return this.getItems()},getPinnedItems(){return this.getItems({pinned:!0})},getUnPinnedTeamItems(){return this.getItems({team:!0})},getPinnedTeamItems(){return this.getItems({pinned:!0,team:!0})},getRoot:t=>Object.values(t.data).find(k)||null,getTeamRoot:t=>Object.values(t.data).find(I)||null,getItemById:t=>e=>{const i=t.data[e];return i||null},buildLinkGroup(){return t=>{var e;const i=[];null==(e=t.linksOrderIds)||e.forEach((t=>{const e=this.getItemById(t);e&&p(e)&&i.push(e)}));const n={...t,links:i};return new f(n)}},adding(){return!(!this.activeItem||this.activeItemId)}},actions:{addItem(){this.activeItem=new f},editItem(t){this.activeItemId=t;const e=this.getItemById(t);e&&u(e)&&(this.activeItem=this.buildLinkGroup(e))},clearActiveItem(){this.activeItem=null,this.activeItemId=""},refresh(){this.loading||this.loaded||(this.loading=!0,t.get({success:t=>{Object.keys(this.data).forEach((e=>{e in t||delete this.data[e]})),t.forEach((t=>r.set(this.data,t.id,t))),this.loaded=!0,this.loading=!1}}))},async updatePartialRootLinksOrderIds(t){const e=this.getRoot;e&&await this.update(e.id,{linksOrderIds:[...new Set([...t,...e.linksOrderIds])]})},async deleteLinkGroup(t){const e=this.getItemById(t);if(!e||!u(e)&&!m(e))throw new Error(`Can't find LinkGroup with id ${t}`);await Promise.allSettled(Object.values(this.data).filter((i=>p(i)&&i.parentLinkId===t||i===e)).map((t=>this.delete(t.id))))},async processMutations(t){t.filter((t=>t.method!==h.Delete&&"linksOrderIds"in t.data)).forEach((e=>{if(e.method===h.Create&&u(e.data)){const i=e.data.linksOrderIds;t.push({method:h.Update,id:e.id,data:{linksOrderIds:i}}),Object.assign(e.data,{linksOrderIds:[]});const n=this.getRoot;if(!n)throw new Error("Can't find RootLink");t.push({method:h.Update,id:n.id,data:{linksOrderIds:[...n.linksOrderIds,e.id]}})}else e.method===h.Update&&(t=t.filter((t=>t!==e))).push(e)}));for(const e of t)switch(e.method){case h.Update:await this.update(e.id,e.data);break;case h.Create:if(k(e.data))throw new Error("Can't create root links");if(I(e.data))throw new Error("Can't create root links");if(m(e.data))throw new Error("Can't create legacy links");await this.create(e.data);break;case h.Delete:{const t=this.getItemById(e.id);if(!t)return;if(k(t))throw new Error("Can't delete root links");if(I(t))throw new Error("Can't delete team root links");await this.delete(e.id);break}}},async create(e){return r.set(this.data,e.id,e),await t.create(e),e},async update(e,i){const n=this.getItemById(e);if(!n)throw new Error(`No data found for ${e}`);const s={...n,...i};return r.set(this.data,e,s),await t.update(e,i),s},async delete(e){return r.delete(this.data,e),t.delete(e)}}}),b=E(),R=Object.freeze(Object.defineProperty({__proto__:null,default:b,makeLinksStore:E,useLinksStore:b},Symbol.toStringTag,{value:"Module"}));export{O as L,f as a,L as b,v as c,g as d,R as l,b as u,w as v};