import{E as e,q as t,g as a,u as s,e as r,A as o,v as i}from"./icon-alert--q0yLTMi.js";import{i as n,h as u,j as c,k as l}from"./index-DQvfDEB6.js";import{a as d}from"./reactiveCustomization-DqGARD3C.js";function g(a){if(!a)throw new e(t.PASSWORD_EMPTY);if(!n(a))throw new e(t.PASSWORD_INVALID)}const w=new class{async generateOneTimePassword(){const{data:e}=await a.post("login/onetime",{medium:"account"});return e.email||(e.uuid=s.getUserUuid()??""),e}async onSuccessfulUserLogin(){localStorage.setItem("loggedIn",String(Date.now())),localStorage.removeItem("onetimeSent"),localStorage.removeItem("doLoginOnNextLoad"),r.sendCrossTabMessage("reload"),await new Promise((e=>{m.trigger("user:successfulLogin",(async()=>{var t;await o.identify(),m.widgetManager.populateWidgets(),m.models.themeManager.initializeThemes(),m.cmd("user.cleanup",{type:"notifications"}),m.cmd("settings.rerender"),m.conditionalFeatures.featureEnabled("team")&&(null==(t=document.getElementsByTagName("body")[0])||t.classList.add("has-team")),e()}))}))}async onSuccessfulAuthResponse(e,t){const a=s.getUserUuid()!==e.user_uuid,r=!!(null==t?void 0:t.keepPreviousUserData);a&&!r&&(s.clearLocalStorage(),await s.clearIndexedDb(),m.trigger("focusMode:stop"),m.models.customization.clear()),await c(e),e.email&&localStorage.setItem("email",e.email),e.features&&m.conditionalFeatures.updateFeatures(e.features),(null==t?void 0:t.migrateLegacy)&&await l.migrateAll()}async login(s,r){try{g(r);const{data:e}=await a.post("user/authenticate",{username:s,password:r});await this.onSuccessfulAuthResponse({...e,email:s},{keepPreviousUserData:!1,migrateLegacy:!1})}catch(o){if(o instanceof e)throw o;throw i(o,{401:t.PASSWORD_INCORRECT})}}async register(t,r,o,n){try{g(o);const{data:{token:e,token_uuid:i,settings:{features:u,user_id:c}}}=await a.post("user/register",{name:t,email:r,password:o,newsletterOptIn:n.newsletterOptIn});await this.onSuccessfulAuthResponse({token:e,token_uuid:i,user_uuid:c,features:u,email:r},{keepPreviousUserData:s.userIsLegacyUnregistered(),migrateLegacy:s.userIsLegacyUnregistered()})}catch(u){if(u instanceof e)throw u;throw i(u)}}async stayUnregistered(e){try{if(localStorage.getItem("unregistered"))return;const{data:{token:t,token_uuid:s,settings:{features:r,user_id:o}}}=await a.post("user/register?canceled=true",{name:e});await this.onSuccessfulAuthResponse({token:t,token_uuid:s,user_uuid:o,features:r},{keepPreviousUserData:!0,migrateLegacy:!1}),d.displayname=e,localStorage.setItem("unregistered","true")}catch(t){throw console.log(t),i(t)}}async checkEmail(s){try{!function(a){if(!a)throw new e(t.EMAIL_EMPTY);if(!u(a))throw new e(t.EMAIL_INVALID.replace("{email}",a))}(s);const{data:r}=await a.post("/user:preregister",{email:s});return r}catch(r){if(r instanceof e)throw r;throw i(r)}}async resetPassword(t,s,r){try{g(r),await a.post("user/forgot",{name:t,email:s,password:r})}catch(o){if(o instanceof e)throw o;throw i(o)}}};export{w as a};