import{a1 as t,M as e,u as o,as as s,at as i,au as a,z as r,j as n,av as u,k as c,e as d,r as l,d as p,w as h,aw as y,a8 as g,c as f,aq as T,p as P,A as S,ax as w}from"./icon-alert--q0yLTMi.js";import{t as v,u as _}from"./preload-helper-DmNsytk6.js";import{e as k,p as F,d as I}from"./index-DQvfDEB6.js";import{a as M,T as E}from"./PomodoroTimers-BWkB-14p.js";import{b}from"./reactiveCustomization-DqGARD3C.js";import{w as A}from"./loginHelpers-BZASe8UD.js";import{m as B}from"./customization-fX3KDebH.js";class D{constructor(t){this.dataService=t}get(t){this.dataService.get(t)}create(t){return this.dataService.create(t.id,t)}}const C=t=>t.reduce(((t,e)=>t+Number(e.aggregatedEntries)),0),N=t=>t.reduce(((t,e)=>t+Number(e.focusMinutes)),0);var U=(t=>(t.FocusEnd="PomodoroTimerEnd_focus",t.FocusAutoplayEnd="PomodoroTimerEnd_focus_autoplay",t.BreakEnd="PomodoroTimerEnd_rest",t.BreakAutoplayEnd="PomodoroTimerEnd_rest_autoplay",t))(U||{});const x=Object.values(U),O={PomodoroTimerEnd_focus:{exclusiveWith:x.filter((t=>"PomodoroTimerEnd_focus"!==t)),id:"PomodoroTimerEnd_focus",notification:{title:"👏 Nicely done! Time for a break.",message:"Take {{dynamic}} minutes to recharge.\nClick to start break.",buttons:[{title:"▶️ Start Break"},{title:"⏳ Focus +10min"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_focus_autoplay:{exclusiveWith:x.filter((t=>"PomodoroTimerEnd_focus_autoplay"!==t)),id:"PomodoroTimerEnd_focus_autoplay",notification:{title:"👏 Nicely done! Time for a break.",message:"Take {{dynamic}} minutes to recharge.\nYour break starts now.",buttons:[{title:"⏳ Focus +10min"},{title:"⏸️ Pause Break"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_rest:{exclusiveWith:x.filter((t=>"PomodoroTimerEnd_rest"!==t)),id:"PomodoroTimerEnd_rest",notification:{title:"🧠 Resume focus",message:"Try to focus during the next {{dynamic}} minutes. Click to start timer.",buttons:[{title:"▶️ Start Focus"},{title:"⏳ Break +10min"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"},PomodoroTimerEnd_rest_autoplay:{exclusiveWith:x.filter((t=>"PomodoroTimerEnd_rest_autoplay"!==t)),id:"PomodoroTimerEnd_rest_autoplay",notification:{title:"🧠 Focus timer started",message:"Try to focus during the next {{dynamic}} minutes, starting now.",buttons:[{title:"⏳ Break +10min"},{title:"⏸️ Pause Focus"}],iconUrl:"/img/app/icon-128.png",type:"basic",priority:2},type:"pomodoro"}};var j=(t=>(t.StartBreak="startBreak",t.PauseBreak="pauseBreak",t.BreakPlus10="breakPlus10",t.StartFocus="startFocus",t.PauseFocus="pauseFocus",t.FocusPlus10="focusPlus10",t))(j||{});const L={PomodoroTimerEnd_focus:"startBreak",PomodoroTimerEnd_focus_0:"startBreak",PomodoroTimerEnd_focus_1:"focusPlus10",PomodoroTimerEnd_focus_autoplay:"",PomodoroTimerEnd_focus_autoplay_0:"focusPlus10",PomodoroTimerEnd_focus_autoplay_1:"pauseBreak",PomodoroTimerEnd_rest:"startFocus",PomodoroTimerEnd_rest_0:"startFocus",PomodoroTimerEnd_rest_1:"breakPlus10",PomodoroTimerEnd_rest_autoplay:"",PomodoroTimerEnd_rest_autoplay_0:"breakPlus10",PomodoroTimerEnd_rest_autoplay_1:"pauseFocus"},W=(t,e,o)=>{let i=10*s;t===M.Focus&&(i=o.focusDuration*s),t===M.Break&&(i=o.restDuration*s);const a=k.currentValue&&e.pomodoroTimerMode||E.Timer;return a===E.CountUp&&(i=Number.POSITIVE_INFINITY),{mode:a,duration:i}},R=5*a,$={permissions:["notifications","alarms"]},z={permissions:["notifications"]};var q=(t=>(t[t.Play=0]="Play",t[t.Pause=1]="Pause",t))(q||{});const V=20*s,Y=90*s,H=3*i,Q="lastInteraction";const G=new class{constructor(){this.state=r("active");const t=t=>{"active"!==t&&"active"===this.state.value&&localStorage.setItem(Q,""+(Date.now()-1)),this.state.value="locked"===t?"idle":t,u((()=>{"active"===t&&localStorage.setItem(Q,`${Date.now()}`)}))};A().then((()=>{setInterval((()=>{"idle"in n()?n().idle.queryState(300,t):localStorage.setItem(Q,`${Date.now()}`)}),30*a)})),"idle"in n()&&(chrome.idle.setDetectionInterval(300),chrome.idle.onStateChanged.addListener(t))}getMsSinceLastInteraction(){const t=Date.now();return t-Number(localStorage.getItem(Q)||t)}},J=async()=>{const t=G.getMsSinceLastInteraction(),e=Date.now()-t,o=tt();return!o.loaded&&o.countUpActive&&o.playing&&t>V&&await o.update({playing:!1,partialProgress:o.partialProgress+(e-o.timeStarted),pausedTimestampFromInactivity:e},!1),o.playing||!o.countUpActive||null===o.pausedTimestampFromInactivity?{}:t<=V?{playing:!0,timeStarted:Date.now(),partialProgress:o.partialProgress+t,pausedTimestampFromInactivity:null}:t<=Y?((async()=>{await c((()=>l.tabVisible)).toBe(!0),d.$emit("flashMessage",{message:"Your timer has been paused due to inactivity.",buttons:[{text:"I was focusing",action:()=>{o.update({playing:!0,timeStarted:Date.now(),partialProgress:o.partialProgress+(Date.now()-e)})},dismissOnClick:!0}],closeButtonEnabled:!0,persist:8e3})})(),{pausedTimestampFromInactivity:null}):t<=H?{pausedTimestampFromInactivity:null}:((async()=>{await c((()=>o.loaded)).toBe(!0),await o.complete({switchAfterComplete:!1,dateComplete:new Date(e).toISOString()}),await o.update({pausedTimestampFromInactivity:null})})(),{})},K=new S({feature:"pomodoro"}),X=b,Z={start:{play:()=>new Audio("sounds/pomo-start.mp3").play()},stop:{play:()=>new Audio("sounds/pomo-stop.mp3").play()},done:{play:()=>new Audio("sounds/pomo-done.mp3").play()}},tt=F((({loadedRef:t,updateAsync:e})=>p("pomodoroSession",{state:()=>({playing:!1,timeStarted:0,activeTimerId:M.Focus,partialProgress:0,pausedTimestampFromInactivity:null}),getters:{loaded:()=>t.value,activeTimer(){return W(this.activeTimerId,X.focusModeSettings,this.pomodoroSettings)},currentProgress(){return this.playing?m.models.date.get("seconds").getTime()-this.timeStarted:0},totalProgress(){return Math.min(this.totalLength,this.currentProgress+this.partialProgress)},totalLength(){return this.activeTimer.duration},timeRemaining(){return Math.max(0,Math.min(this.totalLength,this.totalLength-this.totalProgress))},anyFocusTimerActive(){return!!this.countUpActive||[M.Focus,M.FocusPlusTen].includes(this.activeTimerId)},anyBreakTimerActive(){return!this.countUpActive&&[M.Break,M.BreakPlusTen].includes(this.activeTimerId)},countUpActive(){return this.activeTimer.mode===E.CountUp},pomodoroSettings:()=>X.pomodoroSettings,focusedMinutes(){return this.anyFocusTimerActive?Math.floor(this.totalProgress/s):0},timeToDisplay(){return this.countUpActive?this.totalProgress:this.timeRemaining},hours(){return parseInt(Math.floor(this.timeToDisplay/i).toFixed(0))},minutes(){const t=(Math.floor(this.timeToDisplay/s)%60).toFixed(0);return this.countUpActive&&0===this.hours||this.pomodoroSettings.hideSeconds?t:v(t)},seconds(){return v((Math.floor(this.timeToDisplay/a)%60).toFixed(0))},fullTimeString(){return this.pomodoroSettings.hideSeconds?`${0!==this.hours?this.hours+"h ":""} ${this.minutes}m`:`${0!==this.hours?this.hours+":":""}${this.minutes}:${this.seconds}`}},actions:{async update(t,o){await e(t,o)},resume({playSounds:t=!1}={}){if(!this.playing)return this.pomodoroSettings.sounds&&t&&Z.start.play(),this.syncPendingNotification(),this.update({playing:!0,timeStarted:m.models.date.get("seconds").getTime()})},pause({playSounds:t=!1}={}){if(this.playing)return this.pomodoroSettings.sounds&&t&&Z.stop.play(),this.deleteNotification(),this.update({playing:!1,partialProgress:this.partialProgress+this.currentProgress})},async complete({switchAfterComplete:t=!0,completedManually:e=!1,switchToTimer:o,dateComplete:s=(new Date).toISOString()}={}){this.pomodoroSettings.sounds&&this.totalProgress>0&&Z.done.play();let i=this.activeTimerId;o?i=o:t&&(i=this.anyFocusTimerActive?M.Break:M.Focus,this.pomodoroSettings.autoplay&&g(500).then((()=>{this.resume({playSounds:!1})}))),K.capture("pomodoro complete",{period:this.activeTimerId});const a=this.focusedMinutes;if(this.pomodoroSettings.autoplay&&t&&ot(),await this.update({playing:!1,partialProgress:0,activeTimerId:i}),this.pomodoroSettings.autoplay&&t&&st(),a){const t=rt();t.refresh(),await c((()=>t.loaded)).toBe(!0);const e={focusMinutes:a,dateCreated:s,completed:s,aggregatedEntries:1};0===t.data.length&&m.trigger("pomodoro:firstSessionCompleted"),await t.create(e)}e&&await this.deleteNotification()},async switchTo(t,{startPlaying:e=!0,playSounds:o=!1}={}){this.activeTimerId!==t?(this.playing||0!==this.totalProgress?await this.complete({completedManually:!0,switchToTimer:t}):await this.update({activeTimerId:t}),e&&(await g(500),await this.resume({playSounds:o}))):e&&!this.playing&&await this.resume({playSounds:o})},async restartTimer(){const t=this.playing;await this.complete({switchAfterComplete:!1,completedManually:!0}),t&&await this.resume()},async deleteNotification(){await f.sendMessage({handler:"deleteNotification",args:[x],timeout:4e4})},async syncPendingNotification(t=!1){if(this.pomodoroSettings.browserNotifications){const e=t?this.anyFocusTimerActive?U.FocusAutoplayEnd:U.BreakAutoplayEnd:this.anyFocusTimerActive?U.FocusEnd:U.BreakEnd,o=W(this.anyFocusTimerActive?M.Break:M.Focus,X.focusModeSettings,this.pomodoroSettings).duration/s,i={...structuredClone(O[e]),time:Date.now()+this.timeRemaining};i.notification.message=i.notification.message.replace("{{dynamic}}",`${o}`),T()&&delete i.notification.buttons,await f.sendMessage({handler:"createOrUpdateNotification",args:[i],timeout:4e4})}else await f.sendMessage({handler:"deleteNotificationsOfType",args:["pomodoro"]})},async onNotificationClick(t){switch(L[t]){case j.StartBreak:await this.switchTo(M.Break);break;case j.PauseBreak:this.playing&&this.anyBreakTimerActive&&await this.pause();break;case j.BreakPlus10:await this.switchTo(M.BreakPlusTen);break;case j.StartFocus:await this.switchTo(M.Focus);break;case j.PauseFocus:this.playing&&this.anyFocusTimerActive&&await this.pause();break;case j.FocusPlus10:await this.switchTo(M.FocusPlusTen)}},async ensureNotificationPermissions(){const t=await this.getNotificationsPermissionsToRequest(),e=!t||await new Promise((e=>{m.cmd("modal.open","PERMISSION_REQUEST",{source:"Pomodoro",reason:"To show browser notifications",permissions:t,resolve:e})}));this.saveSettingsToCustomization("browserNotifications",e)},async getNotificationsPermissionsToRequest(){const t=T()?z:$;return await P.permissions.contains(t)?null:t},saveSettingsToCustomization(t,e){B("pomodoroSettings",(o=>{o[t]=e})),this.playing&&this.syncPendingNotification()}}})),{mode:e.Cache,syncAutomatically:!0,fixStateBeforeLoad:async()=>await J()}),et=new I("pomodoro-running",!1);(async()=>{const t=tt();await c((()=>t.loaded)).toBe(!0),et.switchOverToWatchedStoreItem((()=>t.playing))})(),h(G.state,(async t=>{const e=tt();ot(),"active"===t?await e.update(await J()):(await c((()=>e.loaded)).toBe(!0),e.playing&&e.countUpActive&&(await e.pause(),await e.update({pausedTimestampFromInactivity:Date.now()}))),st()}));const{pause:ot,resume:st}=y((()=>et.currentValue),(()=>m.trigger("soundscapes:syncWithPomodoro"))),it=Object.freeze(Object.defineProperty({__proto__:null,default:tt,usePomodoroSessionStore:tt},Symbol.toStringTag,{value:"Module"})),at=(s=(()=>({pomodoroCompletedService:new D(new t("pomodoro",{path:"pomodoro/completed",mode:e.Timestamp,getResponseProperty:"completed",queryParams:{get:{cutoffDays:"7"}}}))}))().pomodoroCompletedService)=>p("pomodoroCompleted",{state:()=>({data:[],loading:!1,loaded:!1}),getters:{currentSessionLength(){const t=tt();return t.pausedTimestampFromInactivity?0:t.focusedMinutes},dataWithCurrentSessionIfActive(t){const e=[...t.data];return this.currentSessionLength>0&&e.push({id:_(),completed:(new Date).toISOString(),focusMinutes:this.currentSessionLength,aggregatedEntries:1}),e},completedStatsDaily(){return t=>{const e=Array(t+1).fill(void 0).map(((t,e)=>o.getDateStringDayOffset(-1*e))).map((t=>this.dataWithCurrentSessionIfActive.filter((e=>((t,e)=>t&&t.completed&&e.includes(o.getDateString(t.completed)))(e,[t])))));return{counts:e.map(C),focusedMinutes:e.map(N)}}},completedStats(){const t=this.completedStatsDaily(0),e=this.completedStatsDaily(m.models.date.get("hour").getDay());return{counts:{today:o.sumArray(t.counts),week:o.sumArray(e.counts),allTime:C(this.dataWithCurrentSessionIfActive)},focusedMinutes:{today:o.sumArray(t.focusedMinutes),week:o.sumArray(e.focusedMinutes),allTime:N(this.dataWithCurrentSessionIfActive)}}},allTimeMinutes(){return this.completedStats.focusedMinutes.allTime},weekMinutes(){return this.completedStats.focusedMinutes.week},todayMinutes(){return this.completedStats.focusedMinutes.today},pastDaysMinutes(){return t=>o.sumArray(this.completedStatsDaily(t).focusedMinutes)},allTime(){return w(60*this.allTimeMinutes*1e3)},week(){return w(60*this.weekMinutes*1e3)},today(){return w(60*this.todayMinutes*1e3)},completedCountSince(){return t=>this.dataWithCurrentSessionIfActive.filter((e=>new Date(e.completed).getTime()>t)).length},pastDays(){return t=>w(60*this.pastDaysMinutes(t)*1e3)}},actions:{refresh(){this.loaded||this.loading||(this.loading=!0,s.get({success:t=>{this.data=t||[],this.loaded=!0,this.loading=!1}}))},async create(t){const e={...t,id:o.uuidv4()};this.data.push(e),await s.create(e)}}}),rt=at(),nt=Object.freeze(Object.defineProperty({__proto__:null,default:rt,makePomodoroCompletedStore:at,usePomodoroCompletedStore:rt},Symbol.toStringTag,{value:"Module"}));export{q as P,R as T,rt as a,it as b,nt as c,L as p,tt as u};